#!/usr/bin/env ruby
# encoding: UTF-8

account, repo = `git config --get remote.origin.url`.strip.split(':').last.split('/')
repo          = repo.split('.').first
branch        = `git symbolic-ref HEAD`.strip.split('/').last
issue         = ARGV.first

# make sure remote branch has latest and greatest from local
`git push origin #{branch}`

require 'rubygems'
require 'excon'
require 'json'

github = Excon.new(
  'http://api.github.com',
  :headers  => headers = { 'Authorization' => 'Basic ' << ['' << ENV['GITHUB_USER'] << ':' << ENV['GITHUB_PASS']].pack('m').delete(Excon::CR_NL) },
  :nonblock => false
)

# add commits in this branch to issue number specified by ARGV[0]
github.request(
  :method => :post,
  :path   => "/repos/#{account}/#{repo}/pulls",
  :body   => {
    :base   => 'master',
    :head   => "#{account}:#{branch}",
    :issue  => issue
  }.to_json
)

# add a comment to the issue to indicate the added commits
github.request(
  :method => :post,
  :path   => "/repos/#{account}/#{repo}/issues/#{issue}/comments",
  :body   => { :body => 'Commits added, converted to pull request.' }.to_json
)
